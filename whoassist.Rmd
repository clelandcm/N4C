---
title: "N4C WHO Assist"
author: "Last Updated"
date: '`r format(Sys.time(), "%B %d, %Y %r %Z")`'
output:
  html_document: 
    highlight: tango
    theme: spacelab
    toc: yes
    toc_depth: 5
  word_document:
    toc: yes
    toc_depth: '5'
always_allow_html: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, comment=NA, fig.width = 6, fig.asp = 0.618, out.width = "80%", fig.align = "center", dev='svg')
```

```{r}
library(data.table)
library(tidyverse)
library(table1)
```

```{r}
load("n4c.RData", .GlobalEnv)
# setDT(n4c)
```

* WHO ASSIST Working Group (2002). The Alcohol, Smoking and Substance Involvement Screening Test (ASSIST): development, reliability and feasibility. _Addiction_, 97 (9): 1183-1194.

* Humeniuk RE, Ali RA, Babor TF, Farrell M, Formigoni ML, Jittiwutikarn J, Boerngen de Larcerda R, Ling W, Marsden J, Monteiro M, Nhiwhatiwa S, Pal H, Poznyak V & Simon S (2008). Validation of the Alcohol Smoking and Substance Involvement Screening Test (ASSIST). _Addiction_ 103(6): 1039-1047.

* Humeniuk RE, Henry-Edwards S, Ali RL, Poznyak V and Monteiro M (2010). _The Alcohol, Smoking and Substance Involvement Screening Test (ASSIST): manual for use in primary care_. Geneva, World Health Organization.

```{r}
assist_Q1_cols <- c("pid", "redcap_event_name", "bl_whoassist1a", "bl_whoassist1b", "bl_whoassist1c",
                    "bl_whoassist1d", "bl_whoassist1e", "bl_whoassist1f", "bl_whoassist1g", "bl_whoassist1h",
                    "bl_whoassist1i", "bl_whoassist1j", "bl_whoassist1k", "bl_whoassist1l")

assist_Q1 <- melt(n4c[redcap_event_name == "Baseline Interview (Arm 2: Assessments)" & !is.na(bl_date), .SD, .SDcols = assist_Q1_cols],
                  id.vars = c("pid","redcap_event_name"), variable.name = "Substance", value.name = "Ever_Used")

assist_Q1[, Substance := gsub("bl_whoassist1", "", Substance)]

assist_Q1[, Substance := car::recode(Substance, "'a'='tob';
                                                 'b'='alc';
                                                 'c'='can';
                                                 'd'='coc';
                                                 'e'='pstm';
                                                 'f'='mthp';
                                                 'g'='inh';
                                                 'h'='sed';
                                                 'i'='hal';
                                                 'j'='popi';
                                                 'k'='sopi';
                                                 'l'='oth'", as.factor = TRUE,
                                     levels = c('tob','alc','can','coc','pstm','mthp','inh','sed','hal','popi','sopi','oth'))]
```

```{r}
# Use P3M

assist_Q2_cols <- c("pid", "redcap_event_name", "bl_whoassist2a", "bl_whoassist2b", "bl_whoassist2c",
                    "bl_whoassist2d", "bl_whoassist2e", "bl_whoassist2f", "bl_whoassist2g", "bl_whoassist2h",
                    "bl_whoassist2i", "bl_whoassist2j", "bl_whoassist2k", "bl_whoassist2l")

assist_Q2 <- melt(n4c[redcap_event_name == "Baseline Interview (Arm 2: Assessments)" & !is.na(bl_date), .SD, .SDcols = assist_Q2_cols],
                  id.vars = c("pid","redcap_event_name"), variable.name = "Substance", value.name = "Use_P3M")

assist_Q2[, Substance := gsub("bl_whoassist2", "", Substance)]

assist_Q2[, Substance := car::recode(Substance, "'a'='tob';
                                                 'b'='alc';
                                                 'c'='can';
                                                 'd'='coc';
                                                 'e'='pstm';
                                                 'f'='mthp';
                                                 'g'='inh';
                                                 'h'='sed';
                                                 'i'='hal';
                                                 'j'='popi';
                                                 'k'='sopi';
                                                 'l'='oth'", as.factor = TRUE,
                                     levels = c('tob','alc','can','coc','pstm','mthp','inh','sed','hal','popi','sopi','oth'))]

assist_Q3_cols <- c("pid", "redcap_event_name", "bl_whoassist3a", "bl_whoassist3b", "bl_whoassist3c",
                    "bl_whoassist3d", "bl_whoassist3e", "bl_whoassist3f", "bl_whoassist3g", "bl_whoassist3h",
                    "bl_whoassist3i", "bl_whoassist3j", "bl_whoassist3k", "bl_whoassist3l")

assist_Q3 <- melt(n4c[redcap_event_name == "Baseline Interview (Arm 2: Assessments)" & !is.na(bl_date), .SD, .SDcols = assist_Q3_cols],
                  id.vars = c("pid","redcap_event_name"), variable.name = "Substance", value.name = "Urge_P3M")

assist_Q3[, Substance := gsub("bl_whoassist3", "", Substance)]

assist_Q3[, Substance := car::recode(Substance, "'a'='tob';
                                                 'b'='alc';
                                                 'c'='can';
                                                 'd'='coc';
                                                 'e'='pstm';
                                                 'f'='mthp';
                                                 'g'='inh';
                                                 'h'='sed';
                                                 'i'='hal';
                                                 'j'='popi';
                                                 'k'='sopi';
                                                 'l'='oth'", as.factor = TRUE,
                                     levels = c('tob','alc','can','coc','pstm','mthp','inh','sed','hal','popi','sopi','oth'))]

assist_Q4_cols <- c("pid", "redcap_event_name", "bl_whoassist4a", "bl_whoassist4b", "bl_whoassist4c",
                    "bl_whoassist4d", "bl_whoassist4e", "bl_whoassist4f", "bl_whoassist4g", "bl_whoassist4h",
                    "bl_whoassist4i", "bl_whoassist4j", "bl_whoassist4k", "bl_whoassist4l")

assist_Q4 <- melt(n4c[redcap_event_name == "Baseline Interview (Arm 2: Assessments)" & !is.na(bl_date), .SD, .SDcols = assist_Q4_cols],
                  id.vars = c("pid","redcap_event_name"), variable.name = "Substance", value.name = "Problems_P3M")

assist_Q4[, Substance := gsub("bl_whoassist4", "", Substance)]

assist_Q4[, Substance := car::recode(Substance, "'a'='tob';
                                                 'b'='alc';
                                                 'c'='can';
                                                 'd'='coc';
                                                 'e'='pstm';
                                                 'f'='mthp';
                                                 'g'='inh';
                                                 'h'='sed';
                                                 'i'='hal';
                                                 'j'='popi';
                                                 'k'='sopi';
                                                 'l'='oth'", as.factor = TRUE,
                                     levels = c('tob','alc','can','coc','pstm','mthp','inh','sed','hal','popi','sopi','oth'))]

assist_Q5_cols <- c("pid", "redcap_event_name", "bl_whoassist5b", "bl_whoassist5c",
                    "bl_whoassist5d", "bl_whoassist5e", "bl_whoassist5f", "bl_whoassist5g", "bl_whoassist5h",
                    "bl_whoassist5i", "bl_whoassist5j", "bl_whoassist5k", "bl_whoassist5l")

assist_Q5 <- melt(n4c[redcap_event_name == "Baseline Interview (Arm 2: Assessments)" & !is.na(bl_date), .SD, .SDcols = assist_Q5_cols],
                  id.vars = c("pid","redcap_event_name"), variable.name = "Substance", value.name = "Failed_P3M")

assist_Q5[, Substance := gsub("bl_whoassist5", "", Substance)]

assist_Q5[, Substance := car::recode(Substance, "'b'='alc';
                                                 'c'='can';
                                                 'd'='coc';
                                                 'e'='pstm';
                                                 'f'='mthp';
                                                 'g'='inh';
                                                 'h'='sed';
                                                 'i'='hal';
                                                 'j'='popi';
                                                 'k'='sopi';
                                                 'l'='oth'", as.factor = TRUE,
                                     levels = c('alc','can','coc','pstm','mthp','inh','sed','hal','popi','sopi','oth'))]

assist_Q6_cols <- c("pid", "redcap_event_name", "bl_whoassist6a", "bl_whoassist6b", "bl_whoassist6c",
                    "bl_whoassist6d", "bl_whoassist6e", "bl_whoassist6f", "bl_whoassist6g", "bl_whoassist6h",
                    "bl_whoassist6i", "bl_whoassist6j", "bl_whoassist6k", "bl_whoassist6l")

assist_Q6 <- melt(n4c[redcap_event_name == "Baseline Interview (Arm 2: Assessments)" & !is.na(bl_date), .SD, .SDcols = assist_Q6_cols],
                  id.vars = c("pid","redcap_event_name"), variable.name = "Substance", value.name = "Concern_Ever")

assist_Q6[, Substance := gsub("bl_whoassist6", "", Substance)]

assist_Q6[, Substance := car::recode(Substance, "'a'='tob';
                                                 'b'='alc';
                                                 'c'='can';
                                                 'd'='coc';
                                                 'e'='pstm';
                                                 'f'='mthp';
                                                 'g'='inh';
                                                 'h'='sed';
                                                 'i'='hal';
                                                 'j'='popi';
                                                 'k'='sopi';
                                                 'l'='oth'", as.factor = TRUE,
                                     levels = c('tob','alc','can','coc','pstm','mthp','inh','sed','hal','popi','sopi','oth'))]

assist_Q7_cols <- c("pid", "redcap_event_name", "bl_whoassist7a", "bl_whoassist7b", "bl_whoassist7c",
                    "bl_whoassist7d", "bl_whoassist7e", "bl_whoassist7f", "bl_whoassist7g", "bl_whoassist7h",
                    "bl_whoassist7i", "bl_whoassist7j", "bl_whoassist7k", "bl_whoassist7l")

assist_Q7 <- melt(n4c[redcap_event_name == "Baseline Interview (Arm 2: Assessments)" & !is.na(bl_date), .SD, .SDcols = assist_Q7_cols],
                  id.vars = c("pid","redcap_event_name"), variable.name = "Substance", value.name = "Cut_Down_Ever")

assist_Q7[, Substance := gsub("bl_whoassist7", "", Substance)]

assist_Q7[, Substance := car::recode(Substance, "'a'='tob';
                                                 'b'='alc';
                                                 'c'='can';
                                                 'd'='coc';
                                                 'e'='pstm';
                                                 'f'='mthp';
                                                 'g'='inh';
                                                 'h'='sed';
                                                 'i'='hal';
                                                 'j'='popi';
                                                 'k'='sopi';
                                                 'l'='oth'", as.factor = TRUE,
                                     levels = c('tob','alc','can','coc','pstm','mthp','inh','sed','hal','popi','sopi','oth'))]
```

```{r}
assist <- Reduce(function(x, y) merge(x, y, intersect(names(x), names(y)), all = TRUE), 
                 list(assist_Q1, assist_Q2, assist_Q3, assist_Q4, assist_Q5, assist_Q6, assist_Q7))
```


```{r}
assist[Ever_Used == "No", Use_P3M := "Never"]
assist[Ever_Used == "No" | Use_P3M == "Never" | Use_P3M == "Never: not used in the last 3 months", Urge_P3M := "Never"]
assist[Ever_Used == "No" | Use_P3M == "Never" | Use_P3M == "Never: not used in the last 3 months", Problems_P3M := "Never"]
assist[Ever_Used == "No" | Use_P3M == "Never" | Use_P3M == "Never: not used in the last 3 months", Failed_P3M := "Never"]
assist[Substance == "tob", Failed_P3M := "Never"]
assist[Ever_Used == "No", Concern_Ever := "Never"]
assist[Ever_Used == "No", Cut_Down_Ever := "Never"]
```

```{r}
assist[, Use_P3M_num := case_when(
            Use_P3M == 'Never' ~ '0',
            Use_P3M == 'Never: not used in the last 3 months' ~ '0',
            Use_P3M == 'Once or Twice: 1 to 2 times in the past 3 months' ~ '2',
            Use_P3M == 'Monthly: Average of 1 to 3 times per month over the last 3 months' ~ '3',
            Use_P3M == 'Weekly: 1 to 4 times per week' ~ '4',
            Use_P3M == 'Daily or almost daily: 5 to 7 days per week' ~ '6',
            is.na(Use_P3M) ~ '0')]

assist[, Urge_P3M_num := case_when(
            Urge_P3M == 'Never' ~ '0',
            Urge_P3M == 'Once or Twice: 1 to 2 times in the past 3 months' ~ '3',
            Urge_P3M == 'Monthly: Average of 1 to 3 times per month over the last 3 months' ~ '4',
            Urge_P3M == 'Weekly: 1 to 4 times per week' ~ '5',
            Urge_P3M == 'Daily or almost daily: 5 to 7 days per week' ~ '6',
            is.na(Urge_P3M) ~ '0')]

assist[, Problems_P3M_num := case_when(
            Problems_P3M == 'Never' ~ '0',
            Problems_P3M == 'Once or Twice: 1 to 2 times in the past 3 months' ~ '4',
            Problems_P3M == 'Monthly: Average of 1 to 3 times per month over the last 3 months' ~ '5',
            Problems_P3M == 'Weekly: 1 to 4 times per week' ~ '6',
            Problems_P3M == 'Daily or almost daily: 5 to 7 days per week' ~ '7',
            is.na(Problems_P3M) ~ '0')]

assist[, Failed_P3M_num := case_when(
        Substance == 'tob' ~ '0',
            Failed_P3M == 'Never' & Substance != 'oth' ~ '0',
            Failed_P3M == 'Once or Twice: 1 to 2 times in the past 3 months' & Substance != 'oth' ~ '5',
            Failed_P3M == 'Monthly: Average of 1 to 3 times per month over the last 3 months' & Substance != 'oth' ~ '6',
            Failed_P3M == 'Weekly: 1 to 4 times per week' & Substance != 'oth' ~ '7',
            Failed_P3M == 'Daily or almost daily: 5 to 7 days per week' & Substance != 'oth' ~ '8',
            Failed_P3M == 'Never' & Substance == 'oth' ~ '0',
            Failed_P3M == 'Once or Twice: 1 to 2 times in the past 3 months' & Substance == 'oth' ~ '4',
            Failed_P3M == 'Monthly: Average of 1 to 3 times per month over the last 3 months' & Substance == 'oth' ~ '5',
            Failed_P3M == 'Weekly: 1 to 4 times per week' & Substance == 'oth' ~ '6',
            Failed_P3M == 'Daily or almost daily: 5 to 7 days per week' & Substance == 'oth' ~ '7',
            is.na(Failed_P3M) ~ '0')]

assist[, Concern_Ever_num := case_when(
            Use_P3M_num == 0 ~ '0',
            Concern_Ever == 'No, Never' ~ '0',
            Concern_Ever == 'Yes, but not in the past 3 months' ~ '3',
            Concern_Ever == 'Yes, in the past 3 months' ~ '6',
            is.na(Concern_Ever) ~ '0')]

assist[, Cut_Down_Ever_num := case_when(
            Use_P3M_num == 0 ~ '0',
            Cut_Down_Ever == 'No, Never' ~ '0',
            Cut_Down_Ever == 'Yes, but not in the past 3 months' ~ '3',
            Cut_Down_Ever == 'Yes, in the past 3 months' ~ '6',
            is.na(Cut_Down_Ever) ~ '0')]
```

```{r}
assist[, Use_P3M_num := as.numeric(Use_P3M_num)]
assist[, Urge_P3M_num := as.numeric(Urge_P3M_num)]
assist[, Problems_P3M_num := as.numeric(Problems_P3M_num)]
assist[, Failed_P3M_num := as.numeric(Failed_P3M_num)]
assist[, Concern_Ever_num := as.numeric(Concern_Ever_num)]
assist[, Cut_Down_Ever_num := as.numeric(Cut_Down_Ever_num)]
```

```{r}
assist[, Risk_Score := Use_P3M_num + Urge_P3M_num + Problems_P3M_num + Failed_P3M_num + Concern_Ever_num + Cut_Down_Ever_num, by = .(pid, Substance)]

assist[, Risk_Category := case_when(Risk_Score %in% 0:3 & Substance != 'alc' ~ 'Lower Risk',
                                    Risk_Score %in% 4:26 & Substance != 'alc' ~ 'Moderate Risk',
                                    Risk_Score > 26 & Substance != 'alc' ~ 'High Risk',
                                    Risk_Score %in% 0:10 & Substance == 'alc' ~ 'Lower Risk',
                                    Risk_Score %in% 11:26 & Substance == 'alc' ~ 'Moderate Risk',
                                    Risk_Score > 26 & Substance == 'alc' ~ 'High Risk'), by = .(pid, Substance)]

assist[, Risk_Category := ordered(Risk_Category, levels = c('Lower Risk','Moderate Risk','High Risk'))]
```

```{r}
assist_wide <- dcast(assist[, .(pid, redcap_event_name, Substance, Risk_Category, Risk_Score)],
                     pid + redcap_event_name ~ Substance, value.var = c("Risk_Category","Risk_Score"))

label(assist_wide$Risk_Category_tob) <- " Tobacco products (cigarettes, chewing tobacco, cigars, etc.)"
label(assist_wide$Risk_Category_alc) <- "Alcoholic beverages (beer, wine, spirits, etc.)"
label(assist_wide$Risk_Category_can) <- "Marijuana (cannabis, pot, grass, hash, etc.)"
label(assist_wide$Risk_Category_coc) <- "Cocaine (coke, crack, etc.)"
label(assist_wide$Risk_Category_pstm) <- "Prescription stimulants (Ritalin, Concerta, Dexedrine, Adderall, diet pills, etc.)"
label(assist_wide$Risk_Category_mthp) <- "Methamphetamine (speed, crystal meth, ice, etc.)"
label(assist_wide$Risk_Category_inh) <- "Inhalants (poppers, nitrous, glue, gas, paint thinner, etc.)"
label(assist_wide$Risk_Category_sed) <- "Sedatives or Sleeping Pills (Valium, Ativan, Xanax, Klonopin, Librium, Rophynol, GHB, etc.)"
label(assist_wide$Risk_Category_hal) <- "Hallucinogens (Ecstasy, LSD, acid, mushrooms, PCP, Special K, etc.)"
label(assist_wide$Risk_Category_sopi) <- "Street opioids (heroin, opium, etc.)"
label(assist_wide$Risk_Category_popi) <- "Prescription opioids (morphine, codeine, fentanyl, oxycodone [Oxycontin, Percocet], hydrocodone [Vicodin], methadone, buprenorphine [Suboxone], etc.)"
label(assist_wide$Risk_Category_oth) <- "Other Drugs"

label(assist_wide$Risk_Score_tob) <- " Tobacco products (cigarettes, chewing tobacco, cigars, etc.)"
label(assist_wide$Risk_Score_alc) <- "Alcoholic beverages (beer, wine, spirits, etc.)"
label(assist_wide$Risk_Score_can) <- "Marijuana (cannabis, pot, grass, hash, etc.)"
label(assist_wide$Risk_Score_coc) <- "Cocaine (coke, crack, etc.)"
label(assist_wide$Risk_Score_pstm) <- "Prescription stimulants (Ritalin, Concerta, Dexedrine, Adderall, diet pills, etc.)"
label(assist_wide$Risk_Score_mthp) <- "Methamphetamine (speed, crystal meth, ice, etc.)"
label(assist_wide$Risk_Score_inh) <- "Inhalants (poppers, nitrous, glue, gas, paint thinner, etc.)"
label(assist_wide$Risk_Score_sed) <- "Sedatives or Sleeping Pills (Valium, Ativan, Xanax, Klonopin, Librium, Rophynol, GHB, etc.)"
label(assist_wide$Risk_Score_hal) <- "Hallucinogens (Ecstasy, LSD, acid, mushrooms, PCP, Special K, etc.)"
label(assist_wide$Risk_Score_sopi) <- "Street opioids (heroin, opium, etc.)"
label(assist_wide$Risk_Score_popi) <- "Prescription opioids (morphine, codeine, fentanyl, oxycodone [Oxycontin, Percocet], hydrocodone [Vicodin], methadone, buprenorphine [Suboxone], etc.)"
label(assist_wide$Risk_Score_oth) <- "Other Drugs"
```

# Risk Categories
```{r}
table1(~ ., data = assist_wide[,.SD, .SDcols = names(assist_wide) %like% "Category"])
```

# Risk Scores
```{r}
table1(~ ., data = assist_wide[,.SD, .SDcols = names(assist_wide) %like% "Score"])
```

```{r}
save(list=c('assist','assist_wide'), file = "whorisk.Rdata")
```
